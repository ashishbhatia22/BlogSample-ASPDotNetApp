Steps

1.) App Setup and Instrumentation


Download the sample app and inspect the code.

In the project the following nuget packages are installed to instrument the app.
The first two are required for OpenTelemetry to function. 

dotnet add package OpenTelemetry
dotnet add package OpenTelemetry.Extensions.Hosting

The following packages are instrumentation libraries that automatically generate traces and spans when you application makes
calls to resources through http or sql requests.

dotnet add package OpenTelemetry.Instrumentation.AspNetCore --prerelease
dotnet add package OpenTelemetry.Instrumentation.Http --prerelease
dotnet add package OpenTelemetry.Instrumentation.SqlClient --prerelease

Note: Some of the packages are in a prerelease state as the standards for the attribute names are
not currently stable. The functionality is stable but the names of the attributes are subject to change.


Next, these packages format traces for AWS XRay to consume.

dotnet add package OpenTelemetry.Contrib.Extensions.AWSXRay
dotnet add package OpenTelemetry.Instrumentation.AWS

1. Deploy the cloudformation template. This well deploy the following resources..
    -- A vpc with 2 availbility zones with a public and private subnet in each.
    -- A load balancer with a ip type target group.
    -- A ECS cluster with 1 EC2 instance node based on linux.
    -- A cloudmap Namcespace to easily connect services on your cluster
    -- 2 ECR repositories for pushing your application and custom adot images.
    -- Amazon Opensearch Cluster to send logs.
    -- Amazon Managed Prometheus to send metrics.
   
aws cloudformation deploy --template ./blog-cf-template.yml --stack-name blog-cf-test-40 --capabilities CAPABILITY_NAMED_IAM

2. Update and register and deploy your adot task defintion.

    -- Update the ecsTaskRole and ecsTaskExecutionRole with the respective arns from the cloudwatch output.
    -- Run the following command using the ecs cli to registier the adot test definition

        aws ecs register-task-definition --cli-input-json file://adot-task-definition.json --region us-east-1

3. Updated and deploy your ECS Service.
    -- Add the private subnets from the cloudformation output to the service-connect-adot.json
    -- Add the default security group to your service and the AdotService Security group to your service.
    -- Run the following command to launch your service.

  aws ecs create-service --cluster BlogCluster --cli-input-json file://adot-service.json


4. Register App Task Definition

     aws ecs register-task-definition --cli-input-json file://sample-app-task-definition.json --region us-east-1

5. Launch the application service by runnin the following command.

   aws ecs create-service --cluster BlogCluster --cli-input-json file://sample-app-service.json 


